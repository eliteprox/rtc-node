<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RTC Stream Preview</title>
<style>
  :root {
    color-scheme: dark;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  }

  body {
    margin: 0;
    background: transparent;
    color: #f5f5ff;
  }

  .preview-shell {
    width: 100%;
    max-width: 520px;
    margin: 0 auto;
    padding: 0 6px 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .header-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding: 2px 0;
  }

  .video-frame {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    border: 1px solid #1c1c24;
    background: #030304;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #050506;
  }

  .title {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .subtitle {
    font-size: 0.75rem;
    color: #8d8fa7;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #3e3e4d;
  }

  .status-dot.connected {
    background: #4ada9d;
  }

  .status-dot.connecting {
    background: #f0b429;
  }

  .status-dot.error {
    background: #ff5f5f;
  }

  .status-strip {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.78rem;
    color: #a0a1ba;
    padding: 4px 0;
  }

  .status-pill {
    color: inherit;
    flex: 1;
  }

  .status-pill.connected {
    color: #c2ffe3;
  }

  .status-pill.connecting {
    color: #f0b429;
  }

  .status-pill.error {
    color: #ff8a8a;
  }

  .controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .button-group {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  button {
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    background: #4646f4;
    color: #fff;
    font-size: 0.85rem;
    transition: all 0.2s ease;
  }

  button:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  button.secondary {
    background: #2a2a34;
    color: #d6d8ef;
  }

  button.success {
    background: #2fbb6f;
    color: #fff;
  }

  button.danger {
    background: #ff5f5f;
    color: #fff;
  }

  button.small {
    padding: 4px 10px;
    font-size: 0.8rem;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .info-strip {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 0.78rem;
    color: #8d8fa7;
  }

  .info-field {
    display: flex;
    gap: 6px;
    align-items: baseline;
  }

  .info-label {
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    color: #74768c;
  }

  .info-value {
    font-size: 0.85rem;
    color: #f5f5ff;
  }

  .lvpr-link {
    margin-left: auto;
    font-size: 0.8rem;
    color: #8ab4ff;
    text-decoration: none;
  }

  .lvpr-link.disabled {
    opacity: 0.4;
    pointer-events: none;
    cursor: default;
  }
</style>
</head>
<body>
  <div class="preview-shell">
    <!-- <div class="header-block">
      <div class="title">RTC Stream Preview</div>
      <div class="subtitle">Live playback via WHEP</div>
    </div> -->

    <div class="video-frame">
      <video id="previewVideo" playsinline autoplay muted controls></video>
    </div>

    <div class="controls">
      <button id="streamToggleBtn" class="success small">Start Stream</button>
      <button id="connectionToggleBtn" class="small">Connect</button>
      <a
        id="lvprLink"
        class="lvpr-link disabled"
        href="#"
        target="_blank"
        rel="noreferrer noopener"
      >
        lvpr.tv link unavailable
      </a>
    </div>

    <div class="status-strip">
      <span class="status-dot" id="statusDot"></span>
      <span class="status-pill" id="connectionState">idle</span>
    </div>

    <div class="info-strip">
      <div class="info-field">
        <span class="info-label">Stream ID</span>
        <span class="info-value" id="streamIdField">—</span>
      </div>
      <div class="info-field">
        <span class="info-label">Playback ID</span>
        <span class="info-value" id="playbackIdField">—</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { ComfyByocRtc } from "./byoc-comfy-rtc.js";

    const elements = {
      streamToggleBtn: document.getElementById("streamToggleBtn"),
      connectionToggleBtn: document.getElementById("connectionToggleBtn"),
      video: document.getElementById("previewVideo"),
      streamIdField: document.getElementById("streamIdField"),
      playbackIdField: document.getElementById("playbackIdField"),
      connectionState: document.getElementById("connectionState"),
      lvprLink: document.getElementById("lvprLink"),
      statusDot: document.getElementById("statusDot"),
    };

    const rtc = new ComfyByocRtc();

    function setConnectionState(state, detail = "") {
      const label = detail ? `${state} · ${detail}` : state;
      elements.connectionState.textContent = label;
      elements.connectionState.className = "status-pill";
      elements.statusDot.className = "status-dot";
      if (state === "connected") {
        elements.connectionState.classList.add("connected");
        elements.statusDot.classList.add("connected");
      } else if (state === "error") {
        elements.connectionState.classList.add("error");
        elements.statusDot.classList.add("error");
      } else if (state === "connecting") {
        elements.connectionState.classList.add("connecting");
        elements.statusDot.classList.add("connecting");
      }
    }

    function updateLvprLink(url) {
      if (url) {
        elements.lvprLink.href = url;
        elements.lvprLink.textContent = "Open playback";
        elements.lvprLink.classList.remove("disabled");
      } else {
        elements.lvprLink.href = "#";
        elements.lvprLink.textContent = "playback link unavailable";
        elements.lvprLink.classList.add("disabled");
      }
    }

    async function refreshSession() {
      try {
        const resp = await fetch("/rtc/session", { cache: "no-store" });
        const payload = await resp.json();
        const s = payload?.session || {};
        elements.streamIdField.textContent = s.stream_id || "—";
        elements.playbackIdField.textContent = s.whep_url || "—";
        updateLvprLink(s.playback_url || "");
        const status = s.status || "idle";
        setConnectionState(status, s.error || "");
        elements.streamToggleBtn.textContent = s.running ? "Stop Stream" : "Start Stream";
        elements.streamToggleBtn.className = s.running ? "danger small" : "success small";
      } catch {
        // ignore
      }
    }

    elements.streamToggleBtn.addEventListener("click", async () => {
      elements.streamToggleBtn.disabled = true;
      try {
        if (rtc.running) {
          setConnectionState("connecting", "stopping");
          await rtc.stop();
        } else {
          setConnectionState("connecting", "starting");
          await rtc.start({ outputVideoEl: elements.video });
        }
      } catch (e) {
        setConnectionState("error", e?.message || "failed");
      } finally {
        elements.streamToggleBtn.disabled = false;
        await refreshSession();
      }
    });

    // Keep the existing UI button but make it a no-op (viewer is managed inside start()).
    elements.connectionToggleBtn.disabled = true;
    elements.connectionToggleBtn.title = "Viewer is managed automatically";

    setInterval(refreshSession, 2000);
    refreshSession();
    window.addEventListener("beforeunload", () => rtc.stop().catch(() => {}));
  </script>
</body>
</html>


